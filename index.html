<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–ú–µ–Ω—é –Ø–Ω—Ü–∑—ã ‚Äî –∑–∞–∫–∞–∑</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 16px; background:#fafafa; }
    h1 { margin: 0 0 12px; font-size: 20px; }
    .hint { color:#666; font-size: 12px; margin-bottom:12px; }
    fieldset { border:1px solid #ddd; border-radius:10px; padding:10px; margin: 12px 0; background:#fff; }
    legend { font-weight: 700; padding: 0 6px; }
    .item-row { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 0; border-bottom:1px dashed #eee; }
    .item-row:last-child { border-bottom:0; }
    .name { flex: 1; }
    .qty-box { display:flex; align-items:center; gap:6px; }
    .btn { border:1px solid #ccc; background:#f7f7f7; border-radius:8px; padding:6px 10px; font-size:16px; min-width:36px; cursor:pointer; }
    .qty { min-width:28px; text-align:center; font-variant-numeric: tabular-nums; }
    .footer { position:sticky; bottom:0; background:#fafafa; padding-top:12px; }
    .primary { width:100%; padding:12px 14px; font-size:16px; border-radius:10px; border:0; background:#2ea6ff; color:#fff; font-weight:700; cursor:pointer; }
    .primary:disabled { opacity:.6; cursor:not-allowed; }
    .totals { display:flex; justify-content:space-between; margin:10px 0; color:#333; }
    .pill { background:#eee; border-radius:999px; padding:2px 8px; }
  </style>
  <!-- SDK Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <h1>–§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ –±–ª—é–¥ –Ø–Ω—Ü–∑—ã</h1>
  <div class="hint">
    –ù–∞–∂–∏–º–∞–π—Ç–µ ¬´+ / ‚Äì¬ª —á—Ç–æ–±—ã –∑–∞–¥–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ. ¬´–°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑¬ª –æ—Ç–ø—Ä–∞–≤–∏—Ç —Ç–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–∏ &gt; 0 –ø—Ä—è–º–æ –≤ –≤–∞—à—É Data Table.
  </div>

  <div id="app"></div>

  <div class="footer">
    <div class="totals">
      <div>–í—ã–±—Ä–∞–Ω–æ –ø–æ–∑–∏—Ü–∏–π: <span id="selCount" class="pill">0</span></div>
      <div>–í—Å–µ–≥–æ —à—Ç.: <span id="sumQty" class="pill">0</span></div>
    </div>
    <button id="submitBtn" class="primary" disabled>–°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑</button>
  </div>

  <script>
    // === –ù–ê–°–¢–†–û–ô–ö–ê: URL –≤–µ–±—Ö—É–∫–∞ n8n ===
    // –ü—Ä–∏–º–µ—Ä: https://your-n8n-host/webhook/yanzi/order
    const WEBHOOK_URL = 'https://YOUR_N8N_HOST/webhook/yanzi/order'; // <- –ó–ê–ú–ï–ù–ò–¢–ï

    // === Telegram Web App API ===
    const tg = window.Telegram?.WebApp || null;

    // === –ú–ï–ù–Æ (–ø—Ä–∏–º–µ—Ä; —Ä–∞—Å—à–∏—Ä—è–π—Ç–µ –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏) ===
    const ITEMS = [
      // –°–∞–ª–∞—Ç—ã
      { id: 1001, category: "–°–∞–ª–∞—Ç—ã", name: "–û—Ä–µ—Ö–æ–≤—ã–π" },
      { id: 1002, category: "–°–∞–ª–∞—Ç—ã", name: "–¢–∞–π—Å–∫–∏–π" },
      { id: 1003, category: "–°–∞–ª–∞—Ç—ã", name: "–°–∞–ª–∞—Ç ¬´–ï–Ω –Ø–Ω—å¬ª" },
      // –ì–æ—Ä—è—á–µ–µ
      { id: 2001, category: "–ì–æ—Ä—è—á–µ–µ", name: "–õ—é –ñ–æ—É –¢–∞–Ω" },
      { id: 2002, category: "–ì–æ—Ä—è—á–µ–µ", name: "–ö–∞–±–∞–Ω –∏ –∂–µ–ª—É–¥–∏" },
      { id: 2003, category: "–ì–æ—Ä—è—á–µ–µ", name: "–ö–∞—à—Ç–∞–Ω—ã —Å –∫—É—Ä–∏—Ü–µ–π" },
      // –°—É–ø—ã
      { id: 3001, category: "–°—É–ø—ã", name: "–¢–ê–ù –§–ï–ù" },
      { id: 3002, category: "–°—É–ø—ã", name: "–¢–æ–º –Ø–º —Å –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç–∞–º–∏" },
      { id: 3003, category: "–°—É–ø—ã", name: "–¢–æ–º –Ø–º —Å –∫—É—Ä–∏—Ü–µ–π" },
      // –î–µ—Å–µ—Ä—Ç—ã
      { id: 4001, category: "–î–µ—Å–µ—Ä—Ç—ã", name: "–ß–∏–∑–∫–µ–π–∫" },
      { id: 4002, category: "–î–µ—Å–µ—Ä—Ç—ã", name: "–ü–∏—Ä–æ–≥ –≤–∏—à–Ω–µ–≤—ã–π" },
      // –ü–∏—Ü—Ü–∞
      { id: 5001, category: "–ü–∏—Ü—Ü–∞", name: "–ü–∏—Ü—Ü–∞ ¬´–ú–∞—Ä–≥–∞—Ä–∏—Ç–∞ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è¬ª" },
      { id: 5002, category: "–ü–∏—Ü—Ü–∞", name: "–ü–∏—Ü—Ü–∞ —Å —è–∑—ã–∫–æ–º" },
      // –ù–∞–ø–∏—Ç–∫–∏
      { id: 6001, category: "–ù–∞–ø–∏—Ç–∫–∏", name: "–í–æ–¥–∞" },
      { id: 6002, category: "–ù–∞–ø–∏—Ç–∫–∏", name: "–ú–æ—Ä—Å –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π –≤ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–µ" },
      // –ë–∏–∑–Ω–µ—Å-–ª–∞–Ω—á
      { id: 7001, category: "–ë–∏–∑–Ω–µ—Å-–ª–∞–Ω—á", name: "–ë–∏–∑–Ω–µ—Å –ª–∞–Ω—á ‚Ññ1" },
      { id: 7002, category: "–ë–∏–∑–Ω–µ—Å-–ª–∞–Ω—á", name: "–ë–∏–∑–Ω–µ—Å –ª–∞–Ω—á ‚Ññ2" },
      // –ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
      { id: 8001, category: "–ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã", name: "–ü–æ–¥–∞—Ä–æ—á–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç" },
      { id: 8002, category: "–ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã", name: "–ü–æ–¥–∞—Ä–æ—á–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç 1000 —Ä." },
    ];

    // === –°–û–°–¢–û–Ø–ù–ò–ï ===
    const state = new Map(); // id -> { ...item, qty }
    ITEMS.forEach(it => state.set(it.id, { ...it, qty: 0 }));

    const byCategory = ITEMS.reduce((acc, it) => {
      (acc[it.category] ||= []).push(it);
      return acc;
    }, {});

    const app = document.getElementById('app');

    function render() {
      app.innerHTML = '';
      for (const [cat, arr] of Object.entries(byCategory)) {
        const fs = document.createElement('fieldset');
        const lg = document.createElement('legend');
        lg.textContent = cat;
        fs.appendChild(lg);

        arr.forEach(it => {
          const row = document.createElement('div');
          row.className = 'item-row';

          const name = document.createElement('div');
          name.className = 'name';
          name.textContent = it.name;

          const box = document.createElement('div');
          box.className = 'qty-box';

          const minus = document.createElement('button');
          minus.className = 'btn';
          minus.type = 'button';
          minus.textContent = '‚Äì';
          minus.addEventListener('click', () => changeQty(it.id, -1));

          const qty = document.createElement('div');
          qty.className = 'qty';
          qty.id = `qty_${it.id}`;
          qty.textContent = '0';

          const plus = document.createElement('button');
          plus.className = 'btn';
          plus.type = 'button';
          plus.textContent = '+';
          plus.addEventListener('click', () => changeQty(it.id, +1));

          box.append(minus, qty, plus);
          row.append(name, box);
          fs.appendChild(row);
        });

        app.appendChild(fs);
      }
      updateTotals();
    }

    function changeQty(id, delta) {
      const rec = state.get(id);
      const next = Math.max(0, (rec.qty || 0) + delta);
      rec.qty = next;
      state.set(id, rec);
      const el = document.getElementById(`qty_${id}`);
      if (el) el.textContent = String(next);
      updateTotals();
    }

    function updateTotals() {
      let sel = 0, sum = 0;
      state.forEach(v => { if (v.qty > 0) { sel += 1; sum += v.qty; } });
      document.getElementById('selCount').textContent = String(sel);
      document.getElementById('sumQty').textContent = String(sum);
      document.getElementById('submitBtn').disabled = sel === 0;
    }

    // === –û–¢–ü–†–ê–í–ö–ê –í N8N DATA TABLE –ß–ï–†–ï–ó WEBHOOK ===
    const btn = document.getElementById('submitBtn');
    btn.addEventListener('click', async () => {
      btn.disabled = true;

      // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
      const selected = [];
      state.forEach(v => { if (v.qty > 0) selected.push({ id: v.id, name: v.name, qty: v.qty }); });
      if (!selected.length) { btn.disabled = false; return; }

      // –î–æ—Å—Ç–∞—ë–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ WebApp
      const u = tg?.initDataUnsafe?.user || {};
      const user_id = u.id;
      const user_full_name = [u.first_name, u.last_name].filter(Boolean).join(' ').trim();

      if (!user_id) {
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ –Ω–µ –∏–∑ Telegram, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
        alert('–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –∏–∑ Telegram –±–æ—Ç–∞. –°–µ–π—á–∞—Å –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Data Table –æ—Ç–∫–ª—é—á–µ–Ω–∞.\n\n' +
              JSON.stringify({ user_id, user_full_name, selected }, null, 2));
        btn.disabled = false;
        return;
      }

      // –ì–æ—Ç–æ–≤–∏–º —Å—Ç—Ä–æ–∫–∏ –∏–º–µ–Ω–Ω–æ –ø–æ–¥ Data Table:
      // [{ user_id, user_full_name, item_name, qty }, ...]
      const rows = selected.map(it => ({
        user_id,
        user_full_name,
        item_name: it.name,
        qty: Number(it.qty),
      }));

      try {
        // –í–∞–∂–Ω–æ: —Ç–æ–ª—å–∫–æ Content-Type, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ preflight
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(rows),
        });

        if (res.ok) {
          tg?.showAlert?.('–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –°–ø–∞—Å–∏–±–æ üôå');
          tg?.close?.();
        } else {
          const text = await res.text().catch(()=> '');
          tg?.showAlert?.('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + text.slice(0, 200));
          btn.disabled = false;
        }
      } catch (e) {
        tg?.showAlert?.('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ' + (e?.message || e));
        btn.disabled = false;
      }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebApp UI
    render();
    if (tg) {
      tg.expand?.();
      tg.setHeaderColor?.('secondary_bg_color');
      tg.setBackgroundColor?.('#fafafa');
      tg.ready?.();
    }
  </script>
</body>
</html>
